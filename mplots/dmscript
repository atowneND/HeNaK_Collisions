#!/bin/bash


###############
#FUNCTION DEFS#
###############

###############
dj_singlem_plot(){
    dj=1
    djmax=4
    while [ $dj -le $djmax ]; do
        echo "#!/usr/local/gnuplot
        set term postscript eps enhanced
        fd='alldata.dat'
        " >$plotfile

        cat $fd | awk '$5=='$dj' {print $1,$2,$3,$4,$5,$6,$7}'>$tmp1file
        # $tmp1file fileds: same as alldata.dat
        # m, j, mp, jp, dj, dtheta, sigma

        m=$((-$dj))
        while [ $m -le $dj ]; do
            ofile=m$m\_dj$dj\_dthetavsigma.ps
            echo "
            set xlabel '{/Symbol s}'
            set ylabel '{/Symbol D}{/Symbol q}'
            set title 'dj=$dj,m=$m'
            plot '$tmp1file' u 7:(\$1==$m?\$6:0/1)

            set output '$ofile'
            replot
            ">>$plotfile
            let m=m+1
        done
        gnuplot <$plotfile >/dev/null
        let dj=dj+1
    done
}
###############

###############
tmp1_for_djdmplotfun(){
    rm $tmp1file 2>/dev/null
    dj=1
    djmax=4
    while [ $dj -le $djmax ]; do
        echo dj=$dj
        cat $fd | awk '$5=='$dj' {print $3-$1,$5,$6,$7}'>>$tmp1file
        # $tmp1file fields: dm, dj, dtheta, sigma
        let dj=dj+1
    done
}
###############

###############
dj_dm_plot(){
    dj=1
    djmax=4
    while [ $dj -le $djmax ]; do
        echo dj=$dj

        for dm in $(awk '{print $1}' $tmp1file|awk '!seen[$0]++'); do
            echo dm=$dm
            ofile=dm$dm\_dj$dj\_dthetavsigma.ps
            echo "#!/usr/local/gnuplot
            set term postscript eps enhanced
            fd='alldata.dat'

            set xlabel '{/Symbol s}'
            set ylabel '{/Symbol D}{/Symbol q}'
            set title 'dj=$dj,dm=$dm'
            plot '$tmp1file' u 4:(\$1==$dm&&\$2==$dj?\$3:0/1)

            set output '$ofile'
            replot
            ">$plotfile
            gnuplot <$plotfile >/dev/null
        done
        let dj=dj+1
    done
}
###############

###############
anglebins(){
    dj=1
    djmax=4
    infile=$tmp1file
    tmpfile=deleteme
    nbins=27
    scale=1
    N=0
    while [ $dj -le $djmax ];do
        echo dj=$dj
        while [ $N -le $nbins ]; do
            lbin=$(($scale*$N))
            ubin=$(($lbin+$scale))
            if [ $N -eq 0 ]; then
                foo[N]=$(awk '$2=='$dj'&&($3<'$ubin'&&$3>'$((-$ubin))') {sum=sum+$4} END {print sum}' $infile)
            else
                foo[N]=$(awk '$2=='$dj'&&($3<'$ubin'&&$3>'$((-$ubin))')&&($3>'$lbin'||$3<'$((-lbin))') {sum=sum+$4} END {print sum}' $infile)
            fi
            let N=N+1
        done
        foo[N]=$(awk '$2=='$dj'&&($3>'$ubin'||$3<'$((-ubin))') {sum=sum+$4} END {print sum}' $infile)
        echo $dj ${foo[*]} >>$tmpfile
        let dj=dj+1
        N=0
    done
    awk '{for(c=1;c<=NF;c++){a[c,NR]=$c};if(max_nf<NF){max_nf=NF};}END{for(c=1;c<=max_nf;c++){for(r=1;r<=NR;r++){if(r==1){printf("%i %s ",1*(c-1),a[c,r]);}else{printf("%s ",a[c,r]);}}print ""}}' $tmpfile >>normbindata
}
###############

###############
anglehist(){
    dj=$(($jp-$j))
    infile=datfiles/jmp_j$j\_jp$jp\_dj$dj\.dat
    ofile=foofile
    pfile=thplotfile
    rm $ofile $pfile $plotfile 2>/dev/null
    sed '/#/d' $infile|awk '{t=$1/sqrt('$j'*('$j'+1));tp=$2/sqrt('$jp'*('$jp'+1));dt=atan2(sqrt(1-tp*tp),tp)-atan2(sqrt(1-t*t),t);print dt*180/3.141592654,$3}'|sed '/nan/d' >$ofile

    t=-180
    divfac=$(awk 'BEGIN {print 2*'$t'/'$wbin'}')
    N=0
    while [ $(awk 'BEGIN {print '$t'<180}') -eq 1 ] 2>/dev/null; do
        read lbin ubin <<<$(getbins2 $wbin $t $divfac)

        if [ $N -eq 0 ]; then
            foo=$(awk '($1<='$ubin') {count++} END {print count}' $ofile)
        else
            foo=$(awk '($1<='$ubin')&&($1>'$lbin') {count++} END {print count}' $ofile)
        fi

        t=$ubin
        let N=N+1
        echo $lbin\to$ubin $foo>>$pfile
    done

    opfile=test_hist_th_j$j\jp$jp\_dj$dj\.ps
    echo "set terminal postscript eps enhanced
    set style data histogram
    set xtic rotate -90
    set xlabel '{/Symbol D}{/Symbol q}'
    set ylabel 'sum of {/Symbol s}s'
    set title 'j=$j, jp=$jp'
    plot '$pfile' u 2:xtic(1)
    set output '$opfile'
    replot">>$plotfile

    gnuplot <$plotfile >deleteme1
    rm $ofile $pfile $plotfile 2>/dev/null
}
###############

###############
dmhist(){
    dj=$(($jp-$j))
    infile=datfiles/jmp_j$j\_jp$jp\_dj$dj\.dat
    ofile=dmdatfile
    pfile=dmplotfile
    rm $pfile $ofile $plotfile 2>/dev/null
    echo \#dm num_dm >$pfile
    sed '/#/d' $infile|awk '{print $2-$1,$3}'>$ofile

    for dm in $(awk '{print $1}' $ofile|awk '!seen[$0]++'); do
        ndm=$(awk '$1=='$dm' {count++} END {print count}' $ofile)
        echo $dm $ndm >>$pfile
    done

    opfile=test_hist_dm_j$j\jp$jp\_dj$dj\.ps
    echo "set terminal postscript eps enhanced
    set xlabel '{/Symbol D}m'
    set ylabel 'count'
    set title 'j=$j, jp=$jp'
    plot '$pfile' with impulse
    replot '$pfile' title ''
    set output '$opfile'
    replot">>$plotfile

    gnuplot <$plotfile >/dev/null 2>&1
    rm $pfile $ofile $plotfile 2>/dev/null
}
###############

###############
weightedanglehist(){
    dj=$(($jp-$j))
    infile=datfiles/jmp_j$j\_jp$jp\_dj$dj\.dat
    ofile=thdatfile
    pfile=thplotfile
    rm $pfile $ofile $plotfile 2>/dev/null
    sed '/#/d' $infile|awk '{t=$1/sqrt('$j'*('$j'+1));tp=$2/sqrt('$jp'*('$jp'+1));dt=atan2(sqrt(1-tp*tp),tp)-atan2(sqrt(1-t*t),t);print dt*180/3.141592654,$3}'|sed '/nan/d' >$ofile
    echo \#mean_theta cs_sum >>$savethdata

    t=-180
    divfac=$(awk 'BEGIN {print 2*'$t'/'$wbin'}')
    N=0
    while [ $(awk 'BEGIN {print '$t'<180}') -eq 1 ] 2>/dev/null; do
        read lbin ubin <<<$(getbins2 $wbin $t $divfac)

        if [ $N -eq 0 ]; then
            foo=$(awk '($1<='$ubin') {sum=sum+$2} END {print sum}' $ofile)
        else
            foo=$(awk '($1<='$ubin')&&($1>'$lbin') {sum=sum+$2} END {print sum}' $ofile)
        fi

        t=$ubin
        echo $lbin\to$ubin $foo>>$pfile
        echo $foo | awk '$1==0||$1 {print ('$lbin'+'$ubin')/2,$1}' >>$savethdata
        let N=N+1
    done

    opfile=test_hist_wth_j$j\jp$jp\_dj$dj\.ps
    echo "set terminal postscript eps enhanced
    set style data histogram
    set xtic rotate -90
    set xlabel '{/Symbol D}{/Symbol q}'
    set ylabel 'sum of {/Symbol s}s'
    set title 'j=$j, jp=$jp'
    plot '$pfile' u 2:xtic(1)
    set output '$opfile'
    replot">>$plotfile

    gnuplot <$plotfile >deleteme1
    rm $pfile $ofile $plotfile 2>/dev/null
}
###############

###############
weighteddmhist(){
    dj=$(($jp-$j))
    infile=datfiles/jmp_j$j\_jp$jp\_dj$dj\.dat
    ofile=dmdatfile
    pfile=dmplotfile
    rm $pfile $ofile $plotfile 2>/dev/null
    echo \#dm num_dm >$pfile
    echo \#dm num_dm >>$savedmdata
    sed '/#/d' $infile|awk '{print $2-$1,$3}'>$ofile

    for dm in $(awk '{print $1}' $ofile|awk '!seen[$0]++'); do
        ndm=$(awk '$1=='$dm' {sum=sum+$2} END {print sum}' $ofile)
        echo $dm $ndm >>$pfile
        echo $dm $ndm >>$savedmdata
    done

    opfile=test_hist_wdm_j$j\jp$jp\_dj$dj\.ps
    echo "set terminal postscript eps enhanced
    set xlabel '{/Symbol D}m'
    set ylabel 'sum of {/Symbol s}s'
    set title 'j=$j, jp=$jp'
    plot '$pfile' u 1:2 with impulse
    replot '$pfile' u 1:2 title ''
    set output '$opfile'
    replot">>$plotfile

    gnuplot <$plotfile >/dev/null 2>&1
    #    rm $pfile $ofile $plotfile 2>/dev/null
}
###############

###############
getbins(){
    #usage: read lbin ubin <<<$(getbins $wbin $t $divfac)
    wbin=$1
    t=$2
    divfac=$3

    if [ "$divfac" -eq "$divfac" ] 2>/dev/null ; then
        #bin width goes into 180 an integer number of times (two bins centered at 0)
        lbin=$t
        ubin=$(awk 'BEGIN {print '$t'+'$wbin'}')
    else
        #bin width goes into 180 half integer number of times (one bin centered at 0)
        nbins=$(awk 'BEGIN {printf("%d\n",(1/2)*(360/'$wbin'-1))}')
        if [ $(awk 'BEGIN {print '$t'==-180}') -eq 1 ]; then
            lbin=$t
            ubin=$(awk 'BEGIN {print -('$wbin'*'$nbins')}')
            #ubin=$(awk 'BEGIN {print '$t'+'$wbin'/2}')
        elif [ $(awk 'BEGIN {print (180<('$t'+'$wbin'))}') -eq 1 ]; then
            lbin=$t
            ubin=180
        else
            lbin=$t
            ubin=$(awk 'BEGIN {print '$t'+'$wbin'}')
        fi
    fi
    echo $lbin $ubin
}
###############

###############
getbins2(){
    #usage: read lbin ubin <<<$(getbins $wbin $t $divfac)
    wbin=$1
    t=$2
    divfac=$3

    read fn dn <<<$(awk 'BEGIN {printf("%f %d\n",180/'$wbin',180/'$wbin')}')
    isodd=$(awk 'BEGIN {print '$wbin'%2}')
    if [ $isodd -eq 1 ]; then
        n=$(awk 'BEGIN {if ('$fn'=='$dn') {print '$dn'} else {print '$dn'+1}}')
    else
        n=$dn
    fi
    if [ $t -eq -180 ] 2>/dev/null ; then
        lbin=$(awk 'BEGIN {print -'$wbin'*'$n'-'$wbin'/2}')
    else
        lbin=$t
    fi
    ubin=$(awk 'BEGIN {print '$lbin'+'$wbin'}')
    echo $lbin $ubin
}
###############

###############
#  MY SCRIPT  #
###############
fd=alldata.dat
tmp1file=tmp1

plotfile=plotme
savethdata=thplottedvalues.dat
savedmdata=dmplottedvalues.dat
rm $savethdata $savedmdata 2>/dev/null
rm $plotfile 2>/dev/null

wbin=1
djlist=(4)
jblist=(30)

for jb in ${jblist[*]}; do
    for dj in ${djlist[*]}; do
        if [ $(($dj%2)) -eq 0 ]; then #even
            jdiff=$(($dj/2))
            j=$(($jb-$jdiff))
            jp=$(($jb+$jdiff))
        else
            jdiff=$(($dj/2))
            j=$(($jb-$jdiff))
            jp=$(($jb+$jdiff+1))
        fi

        echo running \{$j,$jp\}
        echo \#j=$j jp=$jp wbin=$wbin>>$savethdata
        echo \#j=$j jp=$jp >>$savedmdata
        anglehist
        dmhist
        weightedanglehist
        weighteddmhist
        echo '' >>$savethdata
        echo '' >>$savedmdata
    done
done
