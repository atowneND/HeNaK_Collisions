#!/bin/bash

dj=1
rm dtheta.dat
CTR=1
MAX=50
make
rm Run2Results/Stats/check/check*

while [ $dj -le $(($MAX-1)) ]; do
    if [ $dj -lt 10 ]; then
        djstr=0$dj
    else
        djstr=$dj
    fi
    
    statfile=Run2Results/Stats/stats_dj$djstr\.dat
    echo \#j jp SCavg SCstd SCvar QMavg QMstd QMvar diffavg diffstd diffvar>$statfile
    dthOut=Run2Results/dtheta/dtheta_dj$djstr\.dat
    echo j jp jbar dtheta discrete continuous Bmax\(a\) Bmax\(l\) appalpha> $dthOut
    echo Running dj = $dj

    while [ $CTR -lt $(($MAX-$dj+1)) ]; do
        j=$CTR
        jp=$((CTR+$dj))

        # change so zeros are appended
        if [ $jp -lt 10 ]; then
            jpstr=0$jp
        else
            jpstr=$jp
        fi
        if [ $j -lt 10 ]; then
            jstr=0$j
        else
            jstr=$j
        fi

        # dqcalc
        blamdir=Run2Results/Blambdas/
        blamdat=$blamdir\Blambda_$jstr\_$jpstr.dat
        ./dqcalc newdata/Ep002mf5i-50b.blam $blamdat $j $jp

        # dq2theta
        bthdat=Run2Results/Bthetas/Btheta_$jstr\_$jpstr\_dj$djstr\.dat
        normblams=Blam_$jstr\_$jpstr\_dj$djstr\.dat
        read alphamin Bmaxa <<<$(./dq2theta $blamdat $bthdat)
        mv $normblams Run2Results/Blams/$normblams
        normblams=Run2Results/Blams/$normblams

        # get the first angle (for lambda = lambdaMIN)
        # column 3, line 2
        lmindeg=$(cat $normblams|sed -n '2p'|awk '{print $3}')
        Bmaxl=$(cat $normblams|sed -n '2p'|awk '{print $4}') # normalized

        # calculate difference in theta
        dtheta=$(awk "BEGIN {print $lmindeg-$alphamin}")
        jbar=$(awk "BEGIN {print ($j+$jp)/2}")

        # write to file
        appalpha=$(awk "BEGIN {print (180/3.1415926)*(sqrt($jp-$j)/($jbar+1/2))}")
        echo $j $jp $jbar $dtheta $lmindeg $alphamin $Bmaxa $Bmaxl $appalpha>> $dthOut
        outputfile=Run2Results/plots/BPlots_$jstr\_$jpstr\_dj$djstr\.ps

        # stats
        read SCavg SCstd SCvar QMavg QMstd QMvar <<<$(./main.out $j $jp)
        diffavg=$(awk "BEGIN {print "$SCavg"-"$QMavg"}")
        diffstd=$(awk "BEGIN {print "$SCstd"-"$QMstd"}")
        diffvar=$(awk "BEGIN {print "$SCvar"-"$QMvar"}")
        echo $j $jp $SCavg $SCstd $SCvar $QMavg $QMstd $QMvar $diffavg $diffstd $diffvar >>$statfile

        # plot it
        # suppress visual output
        echo "#!/usr/local/gnuplot
#        set term x11 0
        set samples 10000
        set term postscript

        plot '$normblams' using 3:4 with impulse title 'Quantum Mechanical'
        replot '$bthdat' using 1:3 with lines smooth csplines title 'Semiclassical'

        set parametric
        set trange [0:$Bmaxa]
#        set term x11 0
        replot $alphamin,t title 'alpha_min'
        replot $SCavg,t title 'SC average'
        replot $QMavg,t title 'QM average'
        set xlabel 'theta (deg)'
        set ylabel 'B'
        set title 'j=$j, jp=$jp'
        replot

#        set term postscript
        set output '$outputfile'
        replot
        quit
        " > deleteme2

        #    gnuplot -persistent < deleteme2
        gnuplot < deleteme2 > /dev/null

        let CTR=CTR+1
    done

    let dj=dj+1
    CTR=1
done

exit
