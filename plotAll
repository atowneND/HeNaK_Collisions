#!/bin/bash

dj=2
rm dtheta.dat
CTR=1
MAX=49

dthOut=dtheta.dat
echo j jp jbar dtheta discrete continuous Bmax\(a\) Bmax\(l\) appalpha>> $dthOut

while [ $CTR -lt $MAX ]; do
    j=$CTR
    jp=$(($CTR+2))

    # dqcalc
    blamdat=Blambda_$j\_$jp.dat
    ./dqcalc newdata/Ep002mf5i-50b.blam $blamdat $j $jp

    # dq2theta
    if [ $jp -lt 10 ]; then
        bthdat=Btheta_0$j\_0$jp.dat
        normblams=Blam_0$j\_0$jp.dat
    elif [ $j -lt 10 ]; then
        bthdat=Btheta_0$j\_$jp.dat
        normblams=Blam_0$j\_$jp.dat
    else
        bthdat=Btheta_$j\_$jp.dat
        normblams=Blam_$j\_$jp.dat
    fi
    read alphamin Bmaxa <<<$(./dq2theta $blamdat $bthdat)

    # get the first angle (for lambda = lambdaMIN)
    # column 3, line 2
    lmindeg=$(cat $normblams|sed -n '2p'|awk '{print $3}')
    Bmaxl=$(cat $normblams|sed -n '2p'|awk '{print $4}') # normalized

    # calculate difference in theta
    dtheta=$(awk "BEGIN {print $lmindeg-$alphamin}")
    jbar=$(awk "BEGIN {print ($j+$jp)/2}")

    # write to file
    appalpha=$(awk "BEGIN {print (180/3.1415926)*(sqrt($jp-$j)/($jbar+1/2))}")
    echo $appalpha
    echo $j $jp $jbar $dtheta $lmindeg $alphamin $Bmaxa $Bmaxl $appalpha>> $dthOut
    outputfile=BPlots_$j\_$jp\.ps

    # plot it
    echo "#!/usr/local/gnuplot
    set term x11 0
    set samples 10000

    plot '$normblams' using 3:4 with impulse
    replot '$bthdat' using 1:3 with lines smooth csplines

    set parametric
    set trange [0:$Bmax]
    set term x11 0
    replot $alphamin,t
    #replot $alphapp,t

    set term postscript
    set output '$outputfile'
    replot
    quit
    " > deleteme2

#    gnuplot -persistent < deleteme2
#    gnuplot < deleteme2
    let CTR=CTR+1
done
